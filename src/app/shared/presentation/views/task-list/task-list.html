<div class="task-container">
  @if (taskStore.allTasks().length > 0) {
    <div class="add-task-button-container">
      <button class="custom-add-button" (click)="openAddDialog()">
        <mat-icon>add</mat-icon>
        Añadir Nota
      </button>
    </div>
  }

  <!-- Tasks Grid -->
  <div class="tasks-container">
    @if (taskStore.allTasks().length === 0) {
      <app-empty-state
        animationPath="assets/animations/empty-box.json"
        title="¡Tu lista de notas está vacía!"
        message="Organiza tu día de manera eficiente creando tu primera nota.<br>Mantén el control de todo lo que necesitas recordar.">
      </app-empty-state>
    } @else {
      <div class="tasks-grid">
        @for (task of taskStore.allTasks(); track task.id) {
          <div class="task-card" [class]="'task-card task-' + task.status + ' priority-' + task.priority + (isTaskAssigned(task) ? '' : ' unassigned')">
            <!-- Card Header -->
            <div class="card-header">
              <div class="task-info">
                <div class="task-icon-container">
                  <mat-icon class="task-icon">{{ getPriorityIcon(task.priority) }}</mat-icon>
                </div>
                <div class="task-details">
                  <h3 class="task-title" [class.completed-text]="task.status === 'completed'">
                    {{ task.title }}
                  </h3>
                  @if (task.description) {
                    <p class="task-description">{{ task.description }}</p>
                  }
                </div>
              </div>
              <div class="card-actions">
                <button mat-icon-button (click)="deleteTask(task.id)" class="action-btn delete-btn" title="Eliminar tarea">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <!-- Card Content -->
            <div class="card-content">
              <!-- Metadata Section -->
              <div class="metadata-section">
                @if (task.assignee) {
                  <div class="metadata-item">
                    <div class="metadata-label">
                      <mat-icon class="label-icon">person</mat-icon>
                      <span class="label-text">Asignado</span>
                    </div>
                    <div class="assignee-info">
                      <div class="assignee-avatar" [style.--dynamic-color]="getMemberColor(task.assignee)" [style.background-color]="getMemberColor(task.assignee)">
                        {{ task.assignee.charAt(0).toUpperCase() }}
                      </div>
                      <span class="assignee-name">{{ task.assignee }}</span>
                    </div>
                  </div>
                }

                @if (getTaskGroup(task.id)) {
                  <div class="metadata-item">
                    <div class="metadata-label">
                      <mat-icon class="label-icon">groups</mat-icon>
                      <span class="label-text">Grupo</span>
                    </div>
                    <div class="group-info">
                      <div class="group-avatar" [style.--dynamic-color]="getGroupColor(getTaskGroup(task.id)?.name!)" [style.background-color]="getGroupColor(getTaskGroup(task.id)?.name!)">
                        {{ getTaskGroup(task.id)?.name.charAt(0).toUpperCase() }}
                      </div>
                      <span class="group-name">{{ getTaskGroup(task.id)?.name }}</span>
                    </div>
                  </div>
                }

                @if (task.dueDate) {
                  <div class="metadata-item">
                    <div class="metadata-label">
                      <mat-icon class="label-icon">event</mat-icon>
                      <span class="label-text">Fecha Límite</span>
                    </div>
                    <div class="due-date-info">
                      <span class="due-date-text">{{ formatDate(task.dueDate) }}</span>
                      @if (isOverdue(task.dueDate, task.status)) {
                        <span class="overdue-badge">Vencida</span>
                      }
                    </div>
                  </div>
                }
              </div>

              <!-- Status Section -->
              <div class="status-section">
                <div class="status-label">
                  <mat-icon class="label-icon">track_changes</mat-icon>
                  <span class="label-text">Estado</span>
                </div>
                <app-status-selector
                  [currentStatus]="getTaskStatusSignal(task.id)"
                  [disabled]="enabledSignal"
                  (statusChange)="updateStatus(task.id, $event)">
                </app-status-selector>
              </div>
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>

<!-- Add Task Dialog -->
@if (isAddDialogOpen()) {
  <div class="dialog-overlay" (click)="closeAddDialog()">
    <div class="dialog-container" (click)="$event.stopPropagation()">
      <!-- Clean Header -->
      <div class="dialog-header">
        <div class="header-content">
          <h2 class="dialog-title">Crear Nueva Tarea</h2>
        </div>
        <button class="close-icon-btn" (click)="closeAddDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <!-- Clean Content -->
      <mat-dialog-content class="dialog-content">
        <div class="modal-layout">
          <!-- Left Column -->
          <div class="modal-column left-column">
            <!-- Task Info -->
            <div class="form-section task-info-card">
              <label class="section-label">Título</label>
              <div class="form-group">
                <input 
                  type="text"
                  [(ngModel)]="newTask().title"
                  placeholder="¿Qué necesitas hacer?"
                  class="input-field"
                  maxlength="100">
                <mat-icon class="input-icon">title</mat-icon>
              </div>

              <label class="section-label">Descripción</label>
              <div class="form-group">
                <textarea 
                  [(ngModel)]="newTask().description"
                  placeholder="Detalles adicionales..."
                  rows="3"
                  maxlength="500"
                  class="input-field textarea-field">
                </textarea>
              </div>
            </div>

            <!-- Assignment -->
            <div class="form-section assignment-card">
              <label class="section-label">Asignar a</label>
              <div class="assignee-preview">
                <app-assignee-selector
                  [selectedAssignee]="newTaskAssigneeSignal"
                  [disabled]="enabledSignal"
                  (assigneeChange)="updateNewTaskAssignee($event)">
                </app-assignee-selector>
              </div>
            </div>
          </div>
          
          <!-- Right Column -->
          <div class="modal-column right-column">
            <!-- Priority -->
            <div class="form-section priority-card">
              <label class="section-label">Prioridad</label>
              
              <div class="form-group">
                <select 
                  [(ngModel)]="newTask().priority" 
                  class="input-field select-field priority-select">
                  <option value="low">Baja</option>
                  <option value="medium">Media</option>
                  <option value="high">Alta</option>
                </select>
                <mat-icon class="input-icon">flag</mat-icon>
              </div>
            </div>

            <!-- Status -->
            <div class="form-section status-card">
              <label class="section-label">Estado</label>
              <div class="status-preview">
                <app-status-selector
                  [currentStatus]="newTaskStatusSignal"
                  [disabled]="enabledSignal"
                  (statusChange)="updateNewTaskStatus($event)">
                </app-status-selector>
              </div>
            </div>

            <!-- Due Date -->
            <div class="form-section due-date-card">
              <label class="section-label">Fecha Límite</label>
              <div class="form-group">
                <input 
                  type="date"
                  [value]="newTaskDueDateSignal()"
                  (input)="updateNewTaskDueDate($any($event.target).value)"
                  class="input-field date-field">
                <mat-icon class="input-icon">event</mat-icon>
              </div>
            </div>

            <!-- Groups -->
            <div class="form-section groups-card">
              <label class="section-label">Grupo</label>
              
              @if (groups().length === 0) {
                <div class="no-groups-message">
                  <mat-icon class="empty-groups-icon">info</mat-icon>
                  <p class="empty-groups-text">No hay grupos disponibles. Crea un grupo para asignar tareas.</p>
                </div>
              } @else {
                <div class="form-group">
                  <select 
                    [value]="selectedGroup()" 
                    (change)="updateSelectedGroup($any($event.target).value)"
                    class="input-field select-field group-select">
                    <option value="">Sin grupo</option>
                    @for (group of groups(); track group.id || group.name) {
                      <option [value]="group.name">
                        {{ group.name }} ({{ group.members.length }} miembro(s))
                      </option>
                    }
                  </select>
                  <mat-icon class="input-icon">groups</mat-icon>
                </div>

                @if (selectedGroup()) {
                  <div class="selected-members-preview">
                    <p class="preview-label">Miembros asignados:</p>
                    <div class="members-chips">
                      @for (member of newTaskAssigneesSignal(); track member) {
                        <div class="member-chip">
                          <span class="member-chip-name">{{ member }}</span>
                          <mat-icon class="chip-remove" (click)="removeMemberFromAssignees(member)">close</mat-icon>
                        </div>
                      }
                    </div>
                  </div>
                }
              }
            </div>
            
          </div>
        </div>
      </mat-dialog-content>

      <!-- Clean Footer -->
      <div class="dialog-footer">
        <button (click)="closeAddDialog()" class="footer-btn cancel">
          Cancelar
        </button>
        <button (click)="addTask()" class="footer-btn create" [disabled]="!isFormValid()">
          Crear Tarea
        </button>
      </div>
    </div>
  </div>
}
