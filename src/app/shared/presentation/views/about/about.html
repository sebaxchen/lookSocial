<div class="about-container">
  @if (taskStore.taskCount() === 0) {
    <app-empty-state
      animationPath="assets/animations/empty-box.json"
      title="No hay tareas aún"
      message="Añade una nota para comenzar"
      ctaText="Crear mi primera nota"
      ctaIcon="add"
      [ctaAction]="openAddDialog.bind(this)">
    </app-empty-state>
  } @else {
  <!-- Add Task Button -->
  <div class="add-task-button-container">
    <button class="custom-add-button" (click)="openAddDialog()">
      <mat-icon>add</mat-icon>
      Añadir Nota
    </button>
  </div>

  <!-- Three Column Layout -->
  <div class="tasks-columns">
    <!-- Not Started Column -->
    <div class="task-column not-started-column">
      <mat-card class="column-header">
        <mat-card-header>
          <mat-card-title>
            Sin Iniciar
          </mat-card-title>
        </mat-card-header>
      </mat-card>
      
      <div 
        class="tasks-list"
        [class.drag-over]="dragOverColumn === 'not-started'"
        (dragover)="onDragOver($event, 'not-started')"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event, 'not-started')">
        @for (task of taskStore.notStartedTasks(); track task.id) {
          <mat-card 
            class="task-card"
            [class.unassigned]="isTaskUnassigned(task.id)">
            <mat-card-content>
              <button 
                class="drag-handle"
                mat-icon-button
                draggable="true"
                (dragstart)="onDragStart($event, task.id)"
                (dragend)="onDragEnd($event)">
                <span class="drag-handle-line">−</span>
              </button>
              <button mat-icon-button (click)="openEditDialog(task)" class="edit-task-btn" title="Editar tarea">
                <mat-icon>edit</mat-icon>
              </button>
              <div class="task-header">
                <div class="priority-icon-container priority-{{ task.priority }}">
                  <mat-icon class="priority-icon">{{ getPriorityIcon(task.priority) }}</mat-icon>
                </div>
                <h3 class="task-title">{{ task.title }}</h3>
              </div>
              
              @if (task.description) {
                <p class="task-description">{{ task.description }}</p>
              }
              
              <div class="task-controls">
                <div class="task-meta">
                  @if (task.dueDate) {
                    <span class="due-date-chip" [class.overdue]="isOverdue(task.dueDate, task.status)">
                      <mat-icon class="due-date-icon">event</mat-icon>
                      <span class="due-date-text">{{ formatDate(task.dueDate) }}</span>
                      @if (isOverdue(task.dueDate, task.status)) {
                        <span class="overdue-indicator">Vencida</span>
                      }
                    </span>
                  }
                  <div class="task-group-selector" (click)="$event.stopPropagation()">
                    <app-group-selector
                      #groupSelector
                      [selectedGroup]="getTaskGroupSignal(task.id)"
                      [disabled]="getDisabledSignal()"
                      (groupChange)="updateGroup(task.id, $event)"
                      (groupDropdownOpen)="closeAssigneeSelector(assigneeSelector)">
                    </app-group-selector>
                  </div>
                  <div class="task-assignee-selector" (click)="$event.stopPropagation()">
                    <app-assignee-selector
                      #assigneeSelector
                      [selectedAssignee]="getTaskAssigneeSignal(task.id)"
                      [disabled]="getDisabledSignal()"
                      (assigneeChange)="updateAssignee(task.id, $event)"
                      (assigneeDropdownOpen)="closeGroupSelector(groupSelector)">
                    </app-assignee-selector>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        }
        
        @if (taskStore.notStartedTasks().length === 0) {
          <div class="empty-state">
            <mat-icon>inbox</mat-icon>
            <p>Arrastra aquí una tarea</p>
          </div>
        }
      </div>
    </div>

    <!-- In Progress Column -->
    <div class="task-column in-progress-column">
      <mat-card class="column-header">
        <mat-card-header>
          <mat-card-title>
            En Progreso
          </mat-card-title>
        </mat-card-header>
      </mat-card>
      
      <div 
        class="tasks-list"
        [class.drag-over]="dragOverColumn === 'in-progress'"
        (dragover)="onDragOver($event, 'in-progress')"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event, 'in-progress')">
        @for (task of taskStore.inProgressTasks(); track task.id) {
          <mat-card 
            class="task-card"
            [class.unassigned]="isTaskUnassigned(task.id)">
            <mat-card-content>
              <button 
                class="drag-handle"
                mat-icon-button
                draggable="true"
                (dragstart)="onDragStart($event, task.id)"
                (dragend)="onDragEnd($event)">
                <span class="drag-handle-line">−</span>
              </button>
              <button mat-icon-button (click)="openEditDialog(task)" class="edit-task-btn" title="Editar tarea">
                <mat-icon>edit</mat-icon>
              </button>
              <div class="task-header">
                <div class="priority-icon-container priority-{{ task.priority }}">
                  <mat-icon class="priority-icon">{{ getPriorityIcon(task.priority) }}</mat-icon>
                </div>
                <h3 class="task-title">{{ task.title }}</h3>
              </div>
              
              @if (task.description) {
                <p class="task-description">{{ task.description }}</p>
              }
              
              <div class="task-controls">
                <div class="task-meta">
                  @if (task.dueDate) {
                    <span class="due-date-chip" [class.overdue]="isOverdue(task.dueDate, task.status)">
                      <mat-icon class="due-date-icon">event</mat-icon>
                      <span class="due-date-text">{{ formatDate(task.dueDate) }}</span>
                      @if (isOverdue(task.dueDate, task.status)) {
                        <span class="overdue-indicator">Vencida</span>
                      }
                    </span>
                  }
                  <div class="task-group-selector" (click)="$event.stopPropagation()">
                    <app-group-selector
                      #groupSelector
                      [selectedGroup]="getTaskGroupSignal(task.id)"
                      [disabled]="getDisabledSignal()"
                      (groupChange)="updateGroup(task.id, $event)"
                      (groupDropdownOpen)="closeAssigneeSelector(assigneeSelector)">
                    </app-group-selector>
                  </div>
                  <div class="task-assignee-selector" (click)="$event.stopPropagation()">
                    <app-assignee-selector
                      #assigneeSelector
                      [selectedAssignee]="getTaskAssigneeSignal(task.id)"
                      [disabled]="getDisabledSignal()"
                      (assigneeChange)="updateAssignee(task.id, $event)"
                      (assigneeDropdownOpen)="closeGroupSelector(groupSelector)">
                    </app-assignee-selector>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        }
        
        @if (taskStore.inProgressTasks().length === 0) {
          <div class="empty-state">
            <mat-icon>work_outline</mat-icon>
            <p>Arrastra aquí una tarea</p>
          </div>
        }
      </div>
    </div>

    <!-- Completed Column -->
    <div class="task-column completed-column">
      <mat-card class="column-header">
        <mat-card-header>
          <mat-card-title>
            Terminadas
          </mat-card-title>
        </mat-card-header>
      </mat-card>
      
      <div 
        class="tasks-list"
        [class.drag-over]="dragOverColumn === 'completed'"
        (dragover)="onDragOver($event, 'completed')"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event, 'completed')">
        @for (task of taskStore.completedTasks(); track task.id) {
          <mat-card 
            class="task-card"
            [class.unassigned]="isTaskUnassigned(task.id)">
            <mat-card-content>
              <button 
                class="drag-handle"
                mat-icon-button
                draggable="true"
                (dragstart)="onDragStart($event, task.id)"
                (dragend)="onDragEnd($event)">
                <span class="drag-handle-line">−</span>
              </button>
              <button mat-icon-button (click)="openEditDialog(task)" class="edit-task-btn" title="Editar tarea">
                <mat-icon>edit</mat-icon>
              </button>
              <div class="task-header">
                <div class="priority-icon-container priority-{{ task.priority }}">
                  <mat-icon class="priority-icon">{{ getPriorityIcon(task.priority) }}</mat-icon>
                </div>
                <h3 class="task-title">{{ task.title }}</h3>
              </div>
              
              @if (task.description) {
                <p class="task-description">{{ task.description }}</p>
              }
              
              <div class="task-controls">
                <div class="task-meta">
                  @if (task.dueDate) {
                    <span class="due-date-chip" [class.overdue]="isOverdue(task.dueDate, task.status)">
                      <mat-icon class="due-date-icon">event</mat-icon>
                      <span class="due-date-text">{{ formatDate(task.dueDate) }}</span>
                      @if (isOverdue(task.dueDate, task.status)) {
                        <span class="overdue-indicator">Vencida</span>
                      }
                    </span>
                  }
                  <div class="task-group-selector" (click)="$event.stopPropagation()">
                    <app-group-selector
                      #groupSelector
                      [selectedGroup]="getTaskGroupSignal(task.id)"
                      [disabled]="getDisabledSignal()"
                      (groupChange)="updateGroup(task.id, $event)"
                      (groupDropdownOpen)="closeAssigneeSelector(assigneeSelector)">
                    </app-group-selector>
                  </div>
                  <div class="task-assignee-selector" (click)="$event.stopPropagation()">
                    <app-assignee-selector
                      #assigneeSelector
                      [selectedAssignee]="getTaskAssigneeSignal(task.id)"
                      [disabled]="getDisabledSignal()"
                      (assigneeChange)="updateAssignee(task.id, $event)"
                      (assigneeDropdownOpen)="closeGroupSelector(groupSelector)">
                    </app-assignee-selector>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        }
        
        @if (taskStore.completedTasks().length === 0) {
          <div class="empty-state">
            <mat-icon>task_alt</mat-icon>
            <p>Arrastra aquí una tarea</p>
          </div>
        }
      </div>
    </div>
  </div>
  }

  <!-- Add Task Dialog -->
  @if (isAddDialogOpen()) {
    <div class="dialog-overlay" (click)="closeAddDialog()">
      <div class="dialog-container" (click)="$event.stopPropagation()">
        <!-- Clean Header -->
        <div class="dialog-header">
          <div class="header-content">
            <h2 class="dialog-title">Crear Nueva Tarea</h2>
          </div>
          <button class="close-icon-btn" (click)="closeAddDialog()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        
        <!-- Clean Content -->
        <mat-dialog-content class="dialog-content">
          <div class="modal-layout">
            <!-- Left Column -->
            <div class="modal-column left-column">
              <!-- Task Info -->
              <div class="form-section task-info-card">
                <label class="section-label">Título</label>
                <div class="form-group">
                  <input 
                    type="text"
                    [(ngModel)]="newTask().title"
                    placeholder="¿Qué necesitas hacer?"
                    class="input-field"
                    maxlength="100">
                  <mat-icon class="input-icon">title</mat-icon>
                </div>
              </div>

              <!-- Assignment -->
              <div class="form-section assignment-card">
                <label class="section-label">Asignar a</label>
                <div class="assignee-preview">
                  <app-assignee-selector
                    [selectedAssignee]="newTaskAssigneeSignal"
                    [disabled]="getDisabledSignal()"
                    (assigneeChange)="updateNewTaskAssignee($event)">
                  </app-assignee-selector>
                </div>
              </div>
            </div>
            
            <!-- Right Column -->
            <div class="modal-column right-column">
              <!-- Priority -->
              <div class="form-section priority-card">
                <label class="section-label">Prioridad</label>
                
                <div class="form-group">
                  <select 
                    [(ngModel)]="newTask().priority" 
                    class="input-field select-field priority-select">
                    <option value="low">Baja</option>
                    <option value="medium">Media</option>
                    <option value="high">Alta</option>
                  </select>
                  <mat-icon class="input-icon">flag</mat-icon>
                </div>
              </div>

              <!-- Due Date -->
              <div class="form-section due-date-card">
                <label class="section-label">Fecha Límite</label>
                <div class="form-group date-input-group">
                  <input 
                    type="date"
                    [value]="newTaskDueDateSignal()"
                    (input)="updateNewTaskDueDate($any($event.target).value)"
                    class="input-field date-field"
                    id="task-due-date">
                  <label for="task-due-date" class="date-input-label">
                    <mat-icon class="input-icon">event</mat-icon>
                  </label>
                </div>
              </div>

              <!-- Groups -->
              <div class="form-section groups-card">
                <label class="section-label">Grupo</label>
                
                @if (groups().length === 0) {
                  <div class="no-groups-message">
                    <mat-icon class="empty-groups-icon">info</mat-icon>
                    <p class="empty-groups-text">No hay grupos disponibles. Crea un grupo para asignar tareas.</p>
                  </div>
                } @else {
                  <div class="form-group">
                    <select 
                      [value]="selectedGroup()" 
                      (change)="updateSelectedGroup($any($event.target).value)"
                      class="input-field select-field group-select">
                      <option value="">Sin grupo</option>
                      @for (group of groups(); track group.id || group.name) {
                        <option [value]="group.name">
                          {{ group.name }}
                        </option>
                      }
                    </select>
                    <mat-icon class="input-icon">groups</mat-icon>
                  </div>

                  @if (selectedGroup()) {
                    <div class="selected-members-preview">
                      <p class="preview-label">Miembros asignados:</p>
                      <div class="members-chips">
                        @for (member of newTaskAssigneesSignal(); track member) {
                          <div class="member-chip">
                            <span class="member-chip-name">{{ member }}</span>
                            <mat-icon class="chip-remove" (click)="removeMemberFromAssignees(member)">close</mat-icon>
                          </div>
                        }
                      </div>
                    </div>
                  }
                }
              </div>
              
            </div>
          </div>
        </mat-dialog-content>

        <!-- Clean Footer -->
        <div class="dialog-footer">
          <button (click)="closeAddDialog()" class="footer-btn cancel">
            Cancelar
          </button>
          <button (click)="addTask()" class="footer-btn create" [disabled]="!isFormValid()">
            Crear Tarea
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Delete Trash Button -->
  @if (taskStore.taskCount() > 0) {
    <button 
      class="trash-button"
      [class.drag-over]="dragOverTrash"
      (dragover)="onTrashDragOver($event)"
      (dragleave)="onTrashDragLeave($event)"
      (drop)="onTrashDrop($event)"
      mat-raised-button
      color="warn">
      <mat-icon>delete</mat-icon>
    </button>
  }
</div>
