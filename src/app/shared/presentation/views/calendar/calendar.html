<div class="calendar-container">
  <div class="calendar-header">
    <div class="calendar-header-top">
      <div class="calendar-title">
        <mat-icon class="calendar-icon">calendar_month</mat-icon>
        <h2>{{ getMonthName() }} {{ currentYear }}</h2>
      </div>
      <div class="calendar-actions">
        <button mat-icon-button (click)="previousMonth()" class="nav-button">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <button mat-button (click)="today()" class="today-button">
          Hoy
        </button>
        <button mat-icon-button (click)="nextMonth()" class="nav-button">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </div>
  </div>

  @if (hasTasksInCurrentMonth()) {
    <div class="calendar-grid">
      <div class="calendar-weekdays">
        <div class="weekday">Dom</div>
        <div class="weekday">Lun</div>
        <div class="weekday">Mar</div>
        <div class="weekday">Mié</div>
        <div class="weekday">Jue</div>
        <div class="weekday">Vie</div>
        <div class="weekday">Sáb</div>
      </div>

      <div class="calendar-days">
        @for (day of getDaysInMonth(); track $index) {
          @if (day.day === 0) {
            <div class="calendar-day empty"></div>
          } @else {
            <div class="calendar-day" 
                 [class.today]="isToday(day.day)"
                 (click)="openDayModal(day)">
              <span class="day-number">{{ day.day }}</span>
              @if (day.tasks && day.tasks.length > 0) {
                <div class="calendar-tasks">
                  @for (task of day.tasks; track task.id) {
                    <div class="task-square" 
                         [class]="'task-square task-status-' + task.status"
                         [class.overdue]="isOverdue(task.dueDate!, task.status)"
                         (click)="openDayModal(day); $event.stopPropagation()">
                    </div>
                  }
                </div>
              }
            </div>
          }
        }
      </div>
    </div>
  } @else {
    <app-empty-state
      variant="simple"
      icon="calendar_today"
      [title]="'No hay tareas este mes'"
      [message]="'No tienes tareas programadas para ' + getMonthName() + ' ' + currentYear">
    </app-empty-state>
  }
</div>

<!-- Day Tasks Modal -->
@if (isDayModalOpen()) {
  <div class="modal-overlay" (click)="closeDayModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Tareas del {{ selectedDay()?.day }} de {{ getMonthName() }}</h2>
        <button class="modal-close-btn" (click)="closeDayModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <div class="modal-content">
        @if (selectedDay()?.tasks && selectedDay()!.tasks.length > 0) {
          <div class="tasks-list-modal">
            @for (task of selectedDay()!.tasks; track task.id) {
              <div class="task-item-modal" [class]="'task-item status-' + task.status + (isOverdue(task.dueDate!, task.status) ? ' overdue' : '') + (task.status === 'completed' ? ' completed' : '')">
                <div class="task-header-modal">
                  <div class="task-title-modal">
                    <mat-icon class="task-icon-small">assignment</mat-icon>
                    <h3 class="task-name">{{ task.title }}</h3>
                  </div>
                  @if (isOverdue(task.dueDate!, task.status)) {
                    <span class="overdue-badge-modal">Vencida</span>
                  }
                  @if (task.status === 'completed') {
                    <mat-icon class="completed-icon">check_circle</mat-icon>
                  }
                </div>
                @if (task.description) {
                  <p class="task-description-modal">{{ task.description }}</p>
                }
                <div class="task-info-modal">
                  @if (task.assignee) {
                    <div class="info-item-modal">
                      <div class="info-avatar-modal" [style.background-color]="getMemberColor(task.assignee)">
                        {{ task.assignee.charAt(0).toUpperCase() }}
                      </div>
                      <span class="info-text-modal">{{ task.assignee }}</span>
                    </div>
                  }
                  @if (getTaskGroup(task.id)) {
                    <div class="info-item-modal">
                      <div class="info-avatar-modal group-avatar-modal" [style.background-color]="getGroupColor(getTaskGroup(task.id)?.name!)">
                        <mat-icon class="group-icon-in-avatar">groups</mat-icon>
                      </div>
                      <span class="info-text-modal">{{ getTaskGroup(task.id)?.name }}</span>
                    </div>
                  }
                </div>
                <div class="task-footer-modal">
                  <span class="task-status-modal" [class]="'status-' + task.status">
                    {{ getStatusText(task.status) }}
                  </span>
                </div>
              </div>
            }
          </div>
        } @else {
          <app-empty-state
            variant="minimal"
            icon="task_alt"
            message="No hay tareas para este día">
          </app-empty-state>
        }
      </div>
    </div>
  </div>
}

